# üöÄ C√≥digo Completo do `db_manager.py`
# ======================================

import sqlite3
import os
import pandas as pd
import logging

DB_DIR = "models"
DB_PATH = os.path.join(DB_DIR, "trading_data.db")

# ‚úÖ 1. Cria√ß√£o do Banco de Dados e Tabelas (Se N√£o Existirem)
def create_database():
    if not os.path.exists(DB_DIR):
        os.makedirs(DB_DIR, exist_ok=True)
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS historical_data (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                symbol TEXT,
                timestamp DATETIME,
                open REAL,
                high REAL,
                low REAL,
                close REAL,
                volume REAL,
                rsi REAL,
                macd REAL,
                macd_signal REAL,
                upper_band REAL,
                mid_band REAL,
                lower_band REAL,
                regime TEXT,
                UNIQUE(symbol, timestamp)
            );
        ''')
        conn.commit()
        conn.close()
        logging.info("‚úÖ Banco de dados criado/verificado com sucesso.")
    except Exception as e:
        logging.error(f"‚ùå Erro ao criar/verificar banco de dados: {e}")

        
# ‚úÖ 2. Armazenamento de Dados Hist√≥ricos
def store_historical_data(df, symbol):
    if df.empty:
        print(f"‚ö†Ô∏è Nenhum dado para {symbol}.")
        return
    try:
        conn = sqlite3.connect(DB_PATH, timeout=10)
        cursor = conn.cursor()
        for _, row in df.iterrows():
            cursor.execute('''
                INSERT OR IGNORE INTO historical_data 
                (symbol, timestamp, open, high, low, close, volume, rsi, macd, macd_signal, upper_band, mid_band, lower_band, regime)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                symbol,
                row['timestamp'].strftime("%Y-%m-%d %H:%M:%S"),
                row['open'], row['high'], row['low'],
                row['close'], row['volume'],
                row.get('rsi', 0), row.get('macd', 0),
                row.get('macd_signal', 0),
                row.get('upper_band', 0),
                row.get('mid_band', 0),
                row.get('lower_band', 0),
                row.get('regime', 'unknown')
            ))
        conn.commit()
        conn.close()
        print(f"‚úÖ Dados armazenados para {symbol}.")
    except Exception as e:
        print(f"‚ùå Erro ao armazenar dados para {symbol}: {e}")

# ‚úÖ 3. Consulta de Intervalo Existente
def get_existing_date_range(symbol):
    try:
        conn = sqlite3.connect(DB_PATH, timeout=10)
        cursor = conn.cursor()
        cursor.execute("SELECT MIN(timestamp), MAX(timestamp) FROM historical_data WHERE symbol = ?", (symbol,))
        result = cursor.fetchone()
        conn.close()
        return result  # (min_date, max_date)
    except Exception as e:
        print(f"‚ùå Erro ao consultar intervalo: {e}")
        return None

# ‚úÖ 4. Recupera√ß√£o de Dados Hist√≥ricos
def get_historical_data_from_db(symbol):
    try:
        conn = sqlite3.connect(DB_PATH, timeout=10)
        query = f"SELECT * FROM historical_data WHERE symbol = '{symbol}'"
        df = pd.read_sql(query, conn)
        conn.close()
        return df
    except Exception as e:
        print(f"‚ùå Erro ao recuperar dados: {e}")
        return pd.DataFrame()


 # ‚úÖ 2. Garantia de Caminho e Tabela Correta

# ‚úÖ 2. Garantia de Caminho e Tabela Correta Antes de Usar o Banco
def ensure_db_ready():
    if not os.path.exists(DB_PATH):
        logging.warning("‚ö†Ô∏è Banco de dados n√£o encontrado. Criando...")
        create_database()
    else:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT count(*) FROM sqlite_master WHERE type='table' AND name='historical_data'")
        table_exists = cursor.fetchone()[0]
        if not table_exists:
            logging.warning("‚ö†Ô∏è Tabela `historical_data` n√£o encontrada. Criando...")
            create_database()
        conn.close()

# ‚úÖ 3. Execu√ß√£o Direta para Criar e Validar o Banco de Dados
if __name__ == "__main__":
    ensure_db_ready()
